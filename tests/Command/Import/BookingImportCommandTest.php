<?php

declare(strict_types=1);

namespace App\Tests\Command\Import;

use App\Command\Import\BookingImportCommand;
use App\Contract\Request\Booking\BookingImport\BookingImportRequest;
use Prophecy\Argument;
use Prophecy\Prophecy\ObjectProphecy;
use Symfony\Component\Console\Tester\CommandTester;

/**
 * @coversDefaultClass \App\Command\Import\BookingImportCommand
 */
class BookingImportCommandTest extends AbstractImportCommandTest
{
    protected ObjectProphecy $partnerRequest;
    protected ObjectProphecy $requestClass;

    protected function setUp(): void
    {
        $this->requestClass = $this->prophesize(BookingImportRequest::class);
        parent::setUp();

        $this->command = new BookingImportCommand(
            $this->logger->reveal(),
            $this->messageBus->reveal(),
            $this->helper->reveal(),
            $this->validator->reveal(),
            $this->serializer->reveal()
        );

        $this->commandTester = new CommandTester($this->command);
        $this->application->add($this->command);
    }

    /**
     * @covers ::__construct
     * @covers ::configure
     * @covers ::execute
     * @covers ::process
     * @covers \App\Contract\Request\Booking\BookingImport\BookingImportRequest
     * @covers \App\Contract\Request\Booking\BookingImport\Guest
     * @dataProvider requestProvider
     */
    public function testExecuteWithInvalidData(\Iterator $bookingImportRequest): void
    {
        $this->executeWithInvalidData($bookingImportRequest);

        $this->assertEquals('r2d2:booking:import', $this->command::getDefaultName());
    }

    /**
     * @covers ::__construct
     * @covers ::configure
     * @covers ::execute
     * @covers ::process
     * @covers \App\Contract\Request\Booking\BookingImport\BookingImportRequest
     * @covers \App\Contract\Request\Booking\BookingImport\Guest
     * @dataProvider requestProvider
     */
    public function testExecuteWithValidData(\Iterator $bookingImportRequest): void
    {
        $this->executeWithValidData($bookingImportRequest);

        $this->assertEquals('r2d2:booking:import', $this->command::getDefaultName());
        $this->messageBus
            ->dispatch(Argument::type(BookingImportRequest::class))
            ->shouldBeCalledTimes(count($bookingImportRequest));
    }

    public function requestProvider(): ?\Generator
    {
        $records = new \ArrayIterator([
            [
                'goldenId' => '16503',
                'boxId' => '16503',
                'experienceId' => '16503',
                'experiencePrice' => '1650',
                'voucher' => '555444333',
                'currency' => 'EUR',
                'arrivalDate' => '2020-01-01 12:00:00',
                'endDate' => '2020-01-02 12:00:00',
                'additionalComment' => 'i would like a sea view, please',
                'customerData' => '0x1F8B08000000000004006D904B6BC2401485CF4F916EAB41939AAA2B0BDD74E1AEBB223298A88198943CA0A5F8DFFB6572190A95615EF77EF79C99FBA3077DAA51AE930A7D71DB30774422F6297388376AD5A992D31572645E54726E198E4C06E3ACA2E4F49F7FE534F1B99E6C6D6C0EE170288D72A6DAB1969E5EEB89F9ACADCE818D7444E16A1A239BF38F0BD12A383E2AA132F16BAA582B94629452AB1B347AF88EB77F5BCD9BDEEF660FFE9E05EDBF5CEFDF5BFBBF369005DC482DB4C46F8EE31AF7B95538F299EFF9D0BD81FCD03E74AEE29F3DFB397815A8CFCCF1A65F02A11B60B2010000',
                'components' => '0x1F8B0800000000000400ED58DB6EDB4610DD4F21FCD2168D554BB6E3D84FB59DB83090B445ECA60F4D105014256D2B8B2C29C97602FF7BCF9C995D91925C2441E2024540F0B69C9DDBCEE52CDFBB2DE7DD00D723D775FBAE87EBAE3B708F303275A9BB7239BF6DB997789A60C4BBDA25EE0CF70A2353F70ED7C45DB81946FA38728CCF402F1C0678AB5D8611EF4A521498A1FCCEC12DF948AE8F3026F4B91B61CE14234255E25BC1ABC7FBCCBD7673B78323C799E04B8D6F1EE329CF04CF535CE7BC961811F9EF7014781FB86F30AFC473865191B7007D82E70C4701B9134AA956A464E4535093DAFC16F4CB687582B739CE19F9791BBF7243CE9AD1B2C4F8072B17D459DE6BEA3E857E29A807D454C6FF06CF947356EDCEDC981CAFA86DB03F771D8C3DA71F32932C6BE43922EBE5377834E5936A382165493B3DBCA66BAA76AACD1535CAE9B5893D9551964A99B4E80BB3B0A09CCC56C2AF4584ACC7907E983668C407B97948F954E6E93975116F4FA8F99C2B587044B4087A0E30B6E0936AB3A0C5F22EFA0C316F443B3B16B1352DA9E89BDC22AA00AF99CD4A3147F494D8F7CC235DC501233D618494666D6291ECB962C1CB81B224C711D747792CC8D137FC58317BD47B212B3A96811A63A5AD917CAB997F7FE0D8620E887F44FB59C3168D678D9CD4FC53328B5266E51CCF1A55225325055E193D91B622E3045FC52379AC0C81BA6F92BD457E1A5775615E4D2CA76A5CB7DC1B1C61BEE79A55F8A235EABDD93B8835EBC25DBA6393D8AE66178C84915920BCB6DC1DE946316A2B771BF97A7AE72A7A6F0B6B257A97183942E6FDC053F80F684507E3578CA2196DBCC188AE85D08927F549ACDFE1D1757BEEB13BC4B5EBDE5A6C8C2C7A26989D5396DAF2B965EFA2F21FE2DCBF47F69F9835FA42B2BB94BDC7F361EC56A9BB90B74FCBDFD2EA67A09F35A2FA4B58BD2EB987F3847C24CA65C6C3C8DDA35CA929E307962CE753AB6153487B18A90738CF68E7E081243ED928F18D5599929535B3BA2F917E0E6F0C59E3B4E214ACB1C14B4FAD7BD756BF8E894772AB9529FBC08CFD6D8955E6ACF7DA4F1616D9439397C4CE97C6AEEC89940ACAECB367FAD84784E686D55BA4FF448FA4D02BE02F6F5845E47F1B114FCD4E515256404485FB2E229514E736E88EC921748F297509FD4351DBEA8C73EB73153B8C5829AB90B8DFCDC6750953AE556AF84A7AC115FD59F3FDD37456BB0BA24C41A913D6AE342299C23C1C505017738FC825698D3EB6D1551997C41075A32BD62B7D2B4850243B8AB845BBF8987536671DD5759C18B26D63F14BC35805DE36A3F0D4D0ABC8DBE698220D91FCC2F0A13CFF6C486A420CF01A34C736AF8F7B4DFEABFC7AC6F339B5CE29738F58AF872C52BD45D70BEBC2613FB28E7A747F20A86B4E5CE02D9A430E788ECD0CE9CD2372F286963B1105F499B97F59F69DD16FD72659F085A0BB39119FEA5751AEC4A3E4419F2B2BD48A4573A351BF4F59098EB0EA1D548A307B41AC7D0D2EA73177854A296AAEE535AC6EF3B88FFF29FD5FC77AD1FCF616476DA83EB9F7CB36EAD8FAD731E37668569786BFC4CB6DADB7B0768146ABE794B44B3C3530BAD5CAB909AD7DCADE33858481AD4BF0C22B8BD2E7E4DEA7EF6AC3DD1227123FBB4022CA2167BD903AA8B3BD55E81F376461BDA243E812C10763C3C2C166C15A09119F44FF3E477A6BD4CD2AB7CCD9346AF43DB54D8C9F726BF3FABA03FFBA03FFBA03FF2F77E09BF084587DCA5A5A114385FAB4DCB3CF6D5D963BD0F6CEF61C3D7B53A53C37EEA26DE86541FF90F99BB96D37AA469BE725232DA3654BAE62579F6BF121BCCF70DFC4BB1D5D8177C66CB9BD87466BA4D6DCD396ACFDD84B94EA1A5FFAB1E72BCD358FCE47D7F091ED43D5C6092D1E91F33C6AD0C5D1610D164CB707F4F2D85097C64E93760F7A76B02F79C2E3006FBBD1FA9C919B47D42FF453E28D49DC3DE4FC9F52F169403F6864C99EE205F3624CDFA8D5CD0EF47FFE2F3461948E58934771CD7DE43F636E857C157C7D439A21B3467C1EF0DF1CF127B65CC4FDDF2BD2CCE35A77702A6D4E7B746FE5497DFB01F3B4C60FF02533D4D444463D44C80E2223507AC685DA7388A3837367634EBD60B5D5BA9A5B9F6DAF66A84C63EB094FFF05257457E220BF672D0BEE649AB48FEEA15C76AAF4A3E75586566E58997322D85E7CAE5B31BEF94F5EC91CF9CBAC0F68F5F3FC05E8DA3F2D3D0491497E777195BF5C72958A20FFDB240A4A43F17716B98AA932E8DAAE6ABF192FB54A22F704369FACC4EDB2DEC99FAC8C11573BFD47BA4E59996D72CF9809C55A043EA1FE0790DE331D17CC1EC53595C5B5279F59C3C3F25C46EDC38ACDA22EC2E9CAEAD5D8EACEAE55CAF03FA259F1EE62C729A9ADA7DC5FAC7254B172690518D28779A3A2BDD99043A2674A2D967B9643DB6BE9EE513B4E16BBD033ACC3CB46874AF935EC7443CEFCCAB8F59C27D5FB36DA77E7FE01ACBCB9DB6C1B0000',
                'roomPrice' => '400.00;1650',
                'roomType' => 'extra_night;oob',
                'beginRoomDate' => '2020-01-01 00:00:00;2020-01-01 00:00:00',
                'endRoomDate' => '2020-01-02 12:00:00;2020-01-02 00:00:00',
            ],
        ]);

        yield [$records];
    }

    public function requestProviderInvalidData(): ?\Generator
    {
        $records = new \ArrayIterator([
            [
                'id' => '9999999999999999999999',
                'type' => 'partner',
                'partnerCeaseDate' => new \DateTime('now'),
                'isChannelManagerEnabled' => '',
                'updatedAt' => '2020-01-01 00:00:00',
            ],
            [
                'id' => '9999999999999999999999',
                'type' => 'partner',
                'partnerCeaseDate' => null,
                'isChannelManagerEnabled' => '',
                'updatedAt' => '2020-01-01 00:00:00',
            ],
            [
                'id' => '9999999999999999999999',
                'type' => 'partner',
                'partnerCeaseDate' => null,
                'isChannelManagerEnabled' => '',
                'updatedAt' => null,
            ],
        ]);

        yield [$records];
    }

    /**
     * @covers::configure
     */
    public function testConfigureOutput()
    {
        $definition = $this->command->getDefinition();

        $this->assertEquals('Command to push CSV booking to the queue', $this->command->getDescription());
        $this->assertArrayHasKey('file', $definition->getArguments());
        $this->assertEquals('CSV file path', $definition->getArgument('file')->getDescription());
    }
}
