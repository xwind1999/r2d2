stages:
  - Build base image
  - Build
  - Test
  - Static analysis
  - App Container Build
  - Pre-deploy Health Check
  - Project Env Deploy
  - Post-deploy Health Check
  - Project Env Validation
  - Build Reports
  - Publish Reports

variables:
  GIT_DEPTH: 1

default:
  image: ${BASE_FULL_IMAGE}
  before_script:
    - echo '10.11.0.178 ie1-i-chef-02' >> /etc/hosts

include:
  - local: '/.ci/build-app-container.yaml'
  - local: '/.ci/deploy.yaml'
  - local: '/.ci/quality.yaml'
  - local: '/.ci/static-analysis.yaml'
  - local: '/.ci/build-reports.yaml'

composer:
  stage: Build
  image: ${BASE_FULL_IMAGE}
  cache:
    key:
      files:
        - composer.lock
        - symfony.lock
    paths:
      - cache/composer
  script:
    - /load-key.sh "${SSH_KNOWN_HOSTS}" "${SSH_KEY}"
    - composer config cache-dir cache/composer
    - composer install -n --no-progress
  artifacts:
    expire_in: 1 day
    paths:
      - vendor/
      - public/bundles
  tags:
    - k8s-alpha

pages:
  stage: Publish Reports
  image: ${BASE_FULL_IMAGE}
  needs:
    - mermaid-generate-images
    - Api-Tests
    - code-tests-aggregate
    - phpmetrics
    - generate-api-reference
  script:
    - rm -rf public/
    - mv report/html/ public/
    - mkdir -p public/reference/
    - mkdir -p public/docs/
    - cp -R reference/* public/reference/
    - cp openapi.json public/
    - cp -R docs/* public/docs/
    - cp docs/html/openapi.html public/reference/r2d2-api/
    - cp docs/html/implemented.html public/reference/r2d2-api/
  artifacts:
    paths:
      - public
    expire_in: 1 day
  tags:
    - k8s-alpha
  only:
    - master
