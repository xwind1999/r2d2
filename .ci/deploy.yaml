variables:
  ENV_WORKDIR: /opt/sbx/r2d2
  DOCKER_COMPOSE_CMD: docker-compose

.deploy:
  stage: Project Env Deploy
  image: docker-registry.production.smartbox.com/chef/chef-knife
  dependencies:
    - build-app-container
  allow_failure: true
  script:
    - >
      export COMMAND="
      export APP_IMAGE=${APP_IMAGE};
      export HOSTNAME=\`hostname -s\`;
      docker pull ${APP_IMAGE};
      cd ${ENV_WORKDIR};
      ${DOCKER_COMPOSE_CMD} rm -fs && sudo ${ENV_WORKDIR}/pull.rb -g && ${DOCKER_COMPOSE_CMD} up -d;
      "
    - ${CI_PROJECT_DIR}/.ci/tools/notify.sh || true
#    - ${CI_PROJECT_DIR}/.ci/tools/notify-newrelic.sh "${ENVIRONMENT_NAME}" "${CONSOLE_NEWRELIC_BUILDING}" || true
    - ${CI_PROJECT_DIR}/.ci/tools/knife-nodes.sh "${ENVIRONMENT_NAME}" "${COMMAND}" -a ipaddress
    - ${CI_PROJECT_DIR}/.ci/tools/knife-nodes.sh "${ENVIRONMENT_NAME}" "docker exec r2d2_api_1 sudo -u www-data composer dump-env prod"
    - ${CI_PROJECT_DIR}/.ci/tools/knife-master.sh "${ENVIRONMENT_NAME}" "docker exec r2d2_api_1 sudo -u www-data bin/console d:schema:update --force -n"
    - ${CI_PROJECT_DIR}/.ci/tools/knife-master.sh "${ENVIRONMENT_NAME}" "docker exec r2d2_api_1 sudo -u www-data bin/console d:m:m -n"
#    - ${CI_PROJECT_DIR}/.ci/tools/notify-newrelic.sh "${ENVIRONMENT_NAME}" "${CONSOLE_NEWRELIC_COMPLETED}" || true

'[DEVINT] Deploy':
  extends: .deploy
  stage: Project Env Deploy
  environment:
    name: ie1-devint-r2d2
  variables:
    ENVIRONMENT_NAME: ie1-devint-r2d2
  only:
    - master
