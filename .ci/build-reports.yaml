generate-api-reference:
  stage: Build Reports
  image: ${BASE_FULL_IMAGE}
  needs:
    - composer
  script:
    - bin/console r2d2:api:dump > openapi.json
  artifacts:
    expire_in: 1 day
    paths:
      - openapi.json
  tags:
    - k8s-alpha

phpmetrics:
  stage: Build Reports
  image: ${BASE_FULL_IMAGE}
  needs:
    - composer
  script:
    - vendor/bin/phpmetrics --report-html=report/html/phpmetrics src
  artifacts:
    expire_in: 1 day
    paths:
      - report/
  tags:
    - k8s-alpha

mermaid-generate-images:
  stage: Build Reports
  image:
    name: jnewland/mermaid.cli
    entrypoint: [""]
  artifacts:
    expire_in: 1 day
    paths:
      - report/
  script:
    - mkdir -p report/html/docs/architecture/diagram/
    - 'cd docs; for flow in architecture/diagram/*.mmd; do node /data/index.bundle.js -i ${flow%%.*}.mmd -o ${flow%%.*}.png; done; cd ..; mv docs/architecture/diagram/*.png report/html/docs/architecture/diagram/;'
    - ls -lah report/html/docs/architecture/diagram/
  only:
    - master
  tags:
    - k8s-alpha
  except:
    - schedules

code-tests-aggregate:
  stage: Build Reports
  image: ${BASE_FULL_IMAGE}
  needs:
    - unitTests
    - infection
  script:
    - echo true
  artifacts:
    expire_in: 1 day
    paths:
      - report/
      - openapi.json
  tags:
    - k8s-alpha

generate-extra-docs:
  stage: Build Reports
  image: ${BASE_FULL_IMAGE}
  needs:
    - composer
  script:
    - >
      vendor/bin/phpadr workspace:list --config=phpadr.yaml | sed 1,3d | head -n -2 | awk '{$1=""$1""": adr/"$1"";print}' | sed -e 's/^/      - /' >> mkdocs.yml
    - bin/console r2d2:exception:dump >> docs/exceptions.md
    - cp README.md docs/
  artifacts:
    expire_in: 1 day
    paths:
      - mkdocs.yml
      - docs/exceptions.md
      - docs/README.md
  tags:
    - k8s-alpha
