variables:
  BASE_IMAGE: docker-registry.production.smartbox.com/millenium-falcon/r2d2-base:latest
  VALIDATION_IMAGE: docker-registry.production.smartbox.com/millenium-falcon/r2d2-validation:latest
  APP_IMAGE: docker-registry.production.smartbox.com/millenium-falcon/r2d2-api:${CI_PIPELINE_ID}_${CI_COMMIT_SHA}

build-base-image:
  stage: Build Base Image
  image: docker:dind
  only:
    - CI-master
  script:
    - >
      docker build --pull
      --tag ${BASE_IMAGE} .ci/docker/base
    - docker push ${BASE_IMAGE}

build-validation-image:
  stage: Build Validation Image
  image: docker:dind
  only:
    - CI-master
  script:
    - >
      docker build --pull
      --tag ${VALIDATION_IMAGE} .ci/docker/validation
    - docker push ${VALIDATION_IMAGE}

cleanup-and-prepare-files:
  stage: Cleanup and Preparation
  cache:
    key:
      files:
        - composer.lock
        - symfony.lock
    paths:
      - cache/composer
  script:
    - /load-key.sh "${SSH_KNOWN_HOSTS}" "${SSH_KEY}"
    - composer config cache-dir cache/composer
    - composer install -n -o --no-progress
    - echo ${CI_COMMIT_SHA} > public/version.txt
    - echo ${CI_COMMIT_TAG} > public/tag.txt
  artifacts:
    expire_in: 1 day
    paths:
      - vendor/
      - public/bundles
      - public/version.txt
      - public/tag.txt
  only:
    - master
    - tags

build-app-container:
  stage: Deploy Setup
  image: docker:dind
  only:
    - master
    - tags
  script:
    - >
      docker build --pull -f .ci/docker/app/Dockerfile
      --tag "$APP_IMAGE" .
    - docker push $APP_IMAGE
