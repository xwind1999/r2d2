variables:
  BASE_IMAGE: docker-registry.production.smartbox.com/millenium-falcon/r2d2-base:latest
  VALIDATION_IMAGE: docker-registry.production.smartbox.com/millenium-falcon/r2d2-validation:latest
  APP_IMAGE: docker-registry.production.smartbox.com/millenium-falcon/r2d2-api:${CI_PIPELINE_ID}_${CI_COMMIT_SHA}

build-base-image:
  stage: Build base image
  image: docker:dind
  only:
    - CI-master
  script:
    - >
      docker build --pull
      --tag ${BASE_IMAGE} .ci/docker/base
    - docker push ${BASE_IMAGE}

build-validation-image:
  stage: Build validation image
  image: docker:dind
  only:
    - CI-master
  script:
    - >
      docker build --pull
      --tag ${VALIDATION_IMAGE} .ci/docker/validation
    - docker push ${VALIDATION_IMAGE}

cleanup-and-prepare-files:
  stage: Static analysis
  dependencies:
    - composer
  cache:
    key:
      files:
        - composer.lock
        - symfony.lock
    paths:
      - cache/composer
  script:
    - composer config cache-dir cache/composer
    - composer install -n -o --no-progress --no-scripts
    - echo ${CI_COMMIT_SHA} > public/version.txt
  artifacts:
    expire_in: 1 day
    paths:
      - vendor/
      - public/bundles
      - public/version.txt
  only:
    - master

build-app-container:
  stage: App Container Build
  image: docker:dind
  dependencies:
    - cleanup-and-prepare-files
  only:
    - master
  script:
    - >
      docker build --pull -f .ci/docker/app/Dockerfile
      --tag "$APP_IMAGE" .
    - docker push $APP_IMAGE
