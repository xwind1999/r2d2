variables:
  BASE_IMAGE: docker-registry.production.smartbox.com/millenium-falcon/r2d2-base:latest
  VALIDATION_IMAGE: docker-registry.production.smartbox.com/millenium-falcon/r2d2-validation:latest
  APP_IMAGE: docker-registry.production.smartbox.com/millenium-falcon/r2d2-api:${CI_PIPELINE_ID}_${CI_COMMIT_SHA}

build-base-image:
  stage: Build Base Image
  image: docker:dind
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_BRANCH'
    - when: never
  script:
    - docker pull ${BASE_IMAGE}
    - docker build --tag ${BASE_IMAGE} .ci/docker/base
    - docker push ${BASE_IMAGE}

build-validation-image:
  stage: Build Validation Image
  image: docker:dind
  rules:
      - if: '$CI_COMMIT_BRANCH == $CI_BRANCH'
      - when: never
  script:
    - docker pull ${BASE_IMAGE}
    - docker pull ${VALIDATION_IMAGE}
    - docker build --tag ${VALIDATION_IMAGE} .ci/docker/validation
    - docker push ${VALIDATION_IMAGE}

build-app-container:
  stage: Deploy Setup
  image: docker:dind
  dependencies:
    - composer
  rules:
    - if: '$CI_COMMIT_BRANCH == $MAIN_BRANCH'
    - when: never
  script:
    - docker pull ${BASE_IMAGE}
    - docker build -f .ci/docker/app/Dockerfile --tag "$APP_IMAGE" .
    - docker push $APP_IMAGE
